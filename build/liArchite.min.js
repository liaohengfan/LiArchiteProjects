function getIconUrlByType(e){var t=_.findWhere(ICON_TYPE_CHECK,{type:e});return t?ICON_ASSET_BASE+t.ico:""}function getPositionByLonLat(e,t,n){var o=new THREE.Vector3;return o.x=n*Math.sin(e)*Math.sin(t),o.y=n*Math.cos(e),o.z=n*Math.sin(e)*Math.cos(t),o}function Rect(e,t,n,o){this.tl=[e||0,t||0],this.br=[n||0,o||0]}function updateBillBoards(e,t){for(var n=(V_WIDTH||0)>>1,o=(V_HEIGHT||0)>>1,i=0;i<e.children.length;i++){var a=e.children[i],r=new THREE.Vector3(a.lockX,a.lockZ,-a.lockY);r.applyProjection(t);var s=Math.round(r.x*n),l=Math.round(r.y*o),h=Math.round(r.z*o);a.position.set(s,l,h);for(var c=!0,u=5,d=0;d<i;d++){var p=a.material.map.image;if(!p){c=!1;break}if(!a.width||!a.height){c=!1;break}var m=a.width/2,f=a.height/2,E=new Rect(a.position.x-m,a.position.y-f,a.position.x+f,a.position.y+f),b=e.children[d],g=b.position,w=b.width/2,y=b.height/2,T=new Rect(g.x-w,g.y-y,g.x+y,g.y+y);if(b.visible&&E.isCollide(T)){c=!1;break}if(E.tl[0]-=u,E.tl[1]-=u,T.tl[0]-=u,T.tl[1]-=u,0==a.visible&&E.isCollide(T)){c=!1;break}}a.visible=c}}function parseVec2Points(e){for(var t=[],n=0;n<e.length;n+=2){var o=new THREE.Vector2(e[n],e[n+1]);if(n>0){var i=t[t.length-1];o.x==i.x&&o.y==i.y||t.push(o)}else t.push(o)}return t}function getLabelTexture(e){var t=document.createElement("canvas"),n=t.getContext("2d");n.strokeStyle="#FFFFFF",n.fillStyle="#000000",n.lineWidth=4,n.font="32px Microsoft Yahei",n.fillText(e,10,40);var o=new THREE.Texture(t);return o}function imageAddBorderTexture(e){var t=document.createElement("canvas");document.body.appendChild(t);var n=t.getContext("2d");n.drawImage(e,0,0);var o=new THREE.Texture(t);return o}function getDataMesh(e,t,n){void 0===t&&(t=1),void 0===n&&(n=16777215);var o={outline3D:new THREE.Object3D,outline2D:new THREE.Object3D};if(e=e||{},e.Outline=e.Outline||[],e.Outline)for(var i={amount:10,bevelEnabled:!1,curveSegments:1,steps:1},a=0;a<e.Outline.length;a++){var r=e.Outline[a];r=r||[];for(var s=0;s<r.length;s++){var l=parseVec2Points(r[s]),h=new THREE.Shape(l),c=new THREE.ShapeGeometry(h),u=new THREE.MeshBasicMaterial({color:n||16777215}),d=new THREE.Mesh(c,u);d.defaultMaterial=u,d.selMaterial=null,i.amount=10*(e.High||t);var p=new THREE.ExtrudeGeometry(h,i),m=new THREE.MeshLambertMaterial({color:n||16777215,side:THREE.DoubleSide}),f=new THREE.Mesh(p,m);f.defaultMaterial=m,f.selMaterial=null,n+=1,o.outline3D.add(f),o.outline2D.add(d)}}return o}function getLimitHeightDataMesh(e,t,n){void 0===t&&(t=1),void 0===n&&(n=16777215);var o={outline3D:new THREE.Object3D,outline2D:new THREE.Object3D};if(e=e||{},e.Outline=e.Outline||[],e.Outline)for(var i={amount:10,bevelEnabled:!1,curveSegments:1,steps:1},a=0;a<e.Outline.length;a++){var r=e.Outline[a];r=r||[];for(var s=0;s<r.length;s++){var l=parseVec2Points(r[s]),h=new THREE.Shape(l),c=new THREE.ShapeGeometry(h),u=new THREE.MeshBasicMaterial({color:n||16777215}),d=new THREE.Mesh(c,u);d.defaultMaterial=u,i.amount=10*t;var p=new THREE.MeshLambertMaterial({color:n||16777215}),m=new THREE.ExtrudeGeometry(h,i),f=new THREE.Mesh(m,p);f.defaultMaterial=p,n+=1,o.outline3D.add(f),o.outline2D.add(d)}}return o}function meshChangeOpacity(e,t){function n(e){if(e&&"Mesh"==e.type&&e.defaultMaterial&&(e.defaultMaterial.transparent=o,e.defaultMaterial.opacity=t),e&&"Sprite"==e.type&&e.defaultMaterial&&(e.defaultMaterial.transparent=o,e.defaultMaterial.opacity=t),e.children&&e.children.length)for(var i=0;i<e.children.length;i++){var a=e.children[i];n(a)}}t=t||1;var o=!0;t>=1&&(o=!1),e&&n(e)}var ArchiteBase=function(){function e(e,t){this.archite_show=!0,this.archite_name="",this.archite_id="",this.is3D=!0,this.showall=!1,this.oriData=null,this.ArchiteName="",this.ArchiteOutLine=[],this.ArchiteID="",this.ArchiteMesh=null,this.ArchiteMesh2D=null,this.floorGround=null,this.floorGround2D=null,this.ArchiteSprite=null,this.ArchiteIcon=null,this.ArchiteLabel=null,this.architeFloors=[],this.buildingOutLine=null,this.buildingOutLineShow=!1,this.pubPointShow=!0,this.funcareaLabelShow=!0,this.oriData=e,this.ArchiteName=this.oriData.building.Name,this.ArchiteOutLine=this.oriData.building.Outline,this.ArchiteID=this.oriData.building._id,this.archite_id=e._id,this.archite_name=e.Name,this.is3D=t,this.oriData.Floors=this.oriData.Floors||[],this.floorGround=new THREE.Object3D,this.floorGround2D=new THREE.Object3D,this.ArchiteMesh=new THREE.Object3D,this.ArchiteMesh2D=new THREE.Object3D,this.ArchiteSprite=new THREE.Object3D,this.ArchiteIcon=new THREE.Object3D,this.ArchiteLabel=new THREE.Object3D,this.ArchiteSprite.add(this.ArchiteIcon),this.ArchiteSprite.add(this.ArchiteLabel),this.floorGround.rotateX(-(Math.PI/2)),this.floorGround2D.rotateX(-(Math.PI/2)),this.ArchiteMesh.rotateX(-(Math.PI/2)),this.ArchiteMesh2D.rotateX(-(Math.PI/2))}return e.prototype.parseBuildingOutLine=function(){this.buildingOutLine=getDataMesh(this.oriData.building).outline3D,this.buildingOutLine.visible=this.buildingOutLineShow,this.ArchiteMesh.add(this.buildingOutLine)},e.prototype.enabledBuildingOutLine=function(e){this.buildingOutLine.visible=e,this.buildingOutLineShow=e},e.prototype.getDefaultFoolr=function(){return this.oriData.building.DefaultFloor},e.prototype.getFloorY=function(e){var t=null,n=0;return e>0?(t=_.filter(this.oriData.Floors,function(t){return t._id<e&&t._id>=0}),_.map(t,function(e){n+=e.High||0}),n):(t=_.filter(this.oriData.Floors,function(t){return t._id>=e&&t._id<=0}),_.map(t,function(e){n-=e.High||0}),n)},e.prototype.enabeld3D=function(e){this.is3D=e,_.map(this.architeFloors,function(t){t.is3D=e})},e.prototype.display2DPattern=function(){var e=this,t=_.filter(e.architeFloors,function(e){return 1==e.showStuts}),n=_.filter(e.architeFloors,function(e){return 2==e.showStuts});if(t.length){t=_.sortBy(t,function(e){return e._id||-100});var o=_.first(t);try{o.stutsChange(1)}catch(e){}var i=_.rest(t);_.map(i,function(e){try{e.stutsChange(0)}catch(e){}}),_.map(n||[],function(e){try{e.stutsChange(0)}catch(e){}})}},e.prototype.showFloorsMeshByID=function(e,t){void 0===t&&(t=!1);var n=null;n=_.findWhere(this.architeFloors,{archite_id:e});var o=null;if(o=_.reject(this.architeFloors,function(t){return t.archite_id==e}),o&&o.length)for(var i=0;i<o.length;i++){var a=o[i];a&&(t?a.stutsChange(0):a.stutsChange(2))}if(n)n.stutsChange(1);else{if(n=this.createFloors(e),!n)return;this.architeFloors.push(n),this.ArchiteMesh.add(n.getFuncAreasMesh(!0)),this.ArchiteMesh2D.add(n.getFuncAreasMesh(!1)),this.floorGround.add(n.getFloorGround(!0)),this.floorGround2D.add(n.getFloorGround(!1)),this.ArchiteIcon.add(n.getPubPoints(this.pubPointShow)),this.ArchiteIcon.add(n.getFuncAreasLabel(this.funcareaLabelShow))}return n},e.prototype.search=function(e){var t=_.filter(this.oriData.Floors||[],function(t){return!!_.findWhere(t.FuncAreas||[],{Name:e})});if(!t||!t.length)return null;var n=t[0],o=this.showFloorsMeshByID(n._id);if(!o)return null;var i=o.searchFuncArea(e);return i?i:null},e.prototype.showAllFloors=function(){var e=this;_.map(e.oriData.Floors||[],function(t,n){var o=_.findWhere(e.architeFloors,{archite_id:t._id});if(o);else{if(o=e.createFloors(t._id),!o)return;e.architeFloors.push(o),e.ArchiteMesh.add(o.getFuncAreasMesh(!0)),e.ArchiteMesh2D.add(o.getFuncAreasMesh(!1)),e.floorGround.add(o.getFloorGround(!0)),e.floorGround2D.add(o.getFloorGround(!1)),e.ArchiteIcon.add(o.getPubPoints(e.pubPointShow)),e.ArchiteIcon.add(o.getFuncAreasLabel(e.funcareaLabelShow))}0==n?o.stutsChange(1):o.stutsChange(2)})},e.prototype.updateBillBoards=function(e){if(e&&(this.pubPointShow||this.funcareaLabelShow)){var t=new THREE.Matrix4;t.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);for(var n=0;n<this.architeFloors.length;n++){var o=this.architeFloors[n];0!=o.showStuts&&(this.pubPointShow&&o.updateSpritesPosition(t),this.funcareaLabelShow&&o.updateLabelsPosition(t))}}},e.prototype.enabledFloorsPubPoints=function(e){this.pubPointShow=e;for(var t=_.where(this.architeFloors,{archite_show:!0}),n=0;n<t.length;n++){var o=t[n];this.ArchiteIcon.add(o.getPubPoints(e))}},e.prototype.enabledFloorsLabel=function(e){this.funcareaLabelShow=e;for(var t=_.where(this.architeFloors,{archite_show:!0}),n=0;n<t.length;n++){var o=t[n];this.ArchiteIcon.add(o.getFuncAreasLabel(e))}},e.prototype.createFloors=function(e){var t=null;if(t=_.findWhere(this.oriData.Floors||[],{_id:e})){var n=this.getFloorY(e),o=new ArchiteFloor(t,80*n);return o}},e}(),ArchiteFuncArea=function(){function e(e,t,n){this.archite_show=!0,this.archite_name="",this.archite_id="",this.mesh=null,this.plane=null,this.archite_id=e._id,this.archite_name=e.Name;var o=getDataMesh(e,t,n);this.mesh=o.outline3D,this.plane=o.outline2D}return e}(),ArchiteFloor=function(){function e(e,t){this.showStuts=1,this.archite_show=!0,this.archite_name="",this.archite_id="",this.floorData=null,this.is3D=!0,this.yAxis=0,this.floorHigh=0,this.PubPoints=null,this.floorGround=null,this.floorGround2D=null,this.funcAreas=[],this.funcAreaMesh=null,this.funcAreaMesh2D=null,this.funcAreasLabels=null,this.floorData=e,this.archite_id=e._id,this.archite_name=e.Name,this.yAxis=t,this.floorHigh=10*e.High}return e.prototype.applyStuts=function(e,t,n){e&&(e.visible=t,t&&meshChangeOpacity(e,n))},e.prototype.updateLabelsPosition=function(e){this.funcAreasLabels&&updateBillBoards(this.funcAreasLabels,e)},e.prototype.updateSpritesPosition=function(e){this.PubPoints&&updateBillBoards(this.PubPoints,e)},e.prototype.stutsChange=function(e){if(e!=this.showStuts)switch(this.showStuts=e,this.showStuts){case 1:this.applyStuts(this.floorGround,!0,1),this.applyStuts(this.funcAreaMesh,!0,1),this.applyStuts(this.floorGround2D,!0,1),this.applyStuts(this.funcAreaMesh2D,!0,1),this.applyStuts(this.PubPoints,!0,1),this.applyStuts(this.funcAreasLabels,!0,1);break;case 2:this.applyStuts(this.floorGround,!0,.1),this.applyStuts(this.funcAreaMesh,!0,.1),this.applyStuts(this.floorGround2D,!0,.1),this.applyStuts(this.funcAreaMesh2D,!0,.1),this.applyStuts(this.PubPoints,!0,.1),this.applyStuts(this.funcAreasLabels,!0,.1);break;default:this.applyStuts(this.floorGround,!1,.1),this.applyStuts(this.funcAreaMesh,!1,.1),this.applyStuts(this.floorGround2D,!1,.1),this.applyStuts(this.funcAreaMesh2D,!1,.1),this.applyStuts(this.PubPoints,!1,.1),this.applyStuts(this.funcAreasLabels,!1,.1)}},e.prototype.getPubPoints=function(e){if(this.PubPoints)return this.PubPoints.visible=e,this.PubPoints;if(this.PubPoints=new THREE.Object3D,this.PubPoints.position.z=this.yAxis,this.PubPoints.visible=e,this.floorData.PubPoint){this.floorData.PubPoint=this.floorData.PubPoint||[];var t=this.floorData.High;t*=10;for(var n=this.yAxis+t,o=0;o<this.floorData.PubPoint.length;o++){var i=this.floorData.PubPoint[o],a=i.Outline[0][0],r=new THREE.Vector3(a[0]||0,a[1],t),s=getIconUrlByType(i.Type),l=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(s),color:16777215}),h=new THREE.Sprite(l);h.lockX=r.x,h.lockY=r.y,h.lockZ=n,h.defaultMaterial=l,h.scale.set(24,24,1),h.width=24,h.height=24,h.position.copy(r),this.PubPoints.add(h)}}return this.PubPoints},e.prototype.getFloorGround=function(e){if(void 0===e&&(e=!0),this.floorGround)return e?this.floorGround:this.floorGround2D;if(this.floorGround=new THREE.Object3D,this.floorGround.position.z=this.yAxis-10,this.floorGround2D=new THREE.Object3D,this.floorGround2D.position.z=this.yAxis+this.floorHigh-1,this.floorData.Outline){var t=getLimitHeightDataMesh(this.floorData,1,16777215);this.floorGround.add(t.outline3D),this.floorGround2D.add(t.outline2D)}return e?this.floorGround:this.floorGround2D},e.prototype.getFuncAreasMesh=function(e){if(this.funcAreaMesh)return e?this.funcAreaMesh:this.funcAreaMesh2D;if(this.funcAreaMesh=new THREE.Object3D,this.funcAreaMesh.position.z=this.yAxis,this.funcAreaMesh2D=new THREE.Object3D,this.funcAreaMesh2D.position.z=this.yAxis+this.floorHigh,this.floorData.FuncAreas)for(var t=this.floorData.FuncAreas,n=this.floorData.High,o=0;o<t.length;o++){var i=[13237193,9947643,13224443],a=_.sample(i),r=new ArchiteFuncArea(t[o],n,a);this.funcAreaMesh.add(r.mesh),this.funcAreaMesh2D.add(r.plane),this.funcAreas.push(r)}return e?this.funcAreaMesh:this.funcAreaMesh2D},e.prototype.searchFuncArea=function(e){var t=_.findWhere(this.funcAreas,{archite_name:e});return t},e.prototype.getFuncAreasLabel=function(e){if(this.funcAreasLabels)return this.funcAreasLabels.visible=e,this.funcAreasLabels;if(this.funcAreasLabels=new THREE.Object3D,this.funcAreasLabels.position.z=this.yAxis,this.funcAreasLabels.visible=e,this.floorData.FuncAreas){this.floorData.FuncAreas=this.floorData.FuncAreas||[];var t=this.floorData.High;t*=10;for(var n=this.yAxis+t,o=0;o<this.floorData.FuncAreas.length;o++){var i=this.floorData.FuncAreas[o],a=i.Center,r=new THREE.Vector3(a[0]||0,a[1],t),s=new THREE.SpriteMaterial({map:getLabelTexture(i.Name||" "),color:16777215});s.map.needsUpdate=!0;var l=new THREE.Sprite(s);l.lockX=r.x,l.lockY=r.y,l.lockZ=n,l.width=50,l.height=25,l.defaultMaterial=s,l.scale.set(100,50,1),l.position.copy(r),this.funcAreasLabels.add(l)}}return this.funcAreasLabels},e}(),V_WIDTH=1280,V_HEIGHT=720,FOR=60,NEAR=10,FAER=1e4,PI2=2*Math.PI,ICON_ASSET_BASE="asset/PublicPointIco/",ICON_TYPE_CHECK=[{name:"ATM",type:"31003",ico:"ATM.png",en:""},{name:"残障洗手间",type:"11005",ico:"crippled.png",en:""},{name:"出入口",type:"31004",ico:"entry.png",en:""},{name:"扶梯",type:"21002",ico:"escalator.png",en:""},{name:"女洗手间",type:"11003",ico:"Female.png",en:""},{name:"问讯处",type:"31001",ico:"inquiry.png",en:""},{name:"直梯",type:"21003",ico:"lift.png",en:""},{name:"补妆间",type:"31002",ico:"Makeup.png",en:""},{name:"男洗手间",type:"11002",ico:"Male.png",en:""},{name:"母婴室",type:"11004",ico:"MomBaby.png",en:""},{name:"楼梯",type:"21001",ico:"stair.png",en:""},{name:"洗手间",type:"11001",ico:"toilet.png",en:""}],msg=function(e){layui.layer?layui.layer.msg(e):alert(e)},ArchiteMain=function(){function e(e,t){if(!Detector.webgl)throw msg("该浏览器不支持webgl / Canvas, 请更换浏览器后尝试！"),new Error("该浏览器不支持webgl / Canvas, 请更换浏览器后尝试！");this.architewebgl=new ArchiteWebGL(e,t)}return e.prototype.render=function(){TWEEN.update(),this.architewebgl.render()},e.prototype.windowResize=function(e,t){V_WIDTH=e,V_HEIGHT=t,this.architewebgl.resize()},e}(),ArchiteWebGL=function(){function e(e,t){this.domContainer=null,this.controlDom=null,this.renderer=null,this.camera=null,this.scene=null,this.curArchite=null,this.defalutCameraPosition=new THREE.Vector3(0,0,0),this.curCameraPosition=new THREE.Vector3(0,0,0),this.defalutCameraTween=null,this.maxPolarAngleInit=Math.PI/2,this.perspectiveControlSet={minPolarAngle:0,maxPolarAngle:Math.PI/2},this.perspectiveControl=null,this.cameraControls=[],this.planeScene=null,this.is3D=!0,this.labelScene=null,this.labelCamera=null,this.lookatTween=null,this.lookatVector3=new THREE.Vector3(0,0,0),this.selectEnabled=!0,this.raycaster=null,this.meshSelDownPoint=new THREE.Vector2(0,0),this.isSel=!0,this.SelMesh=null,this.SelMaterial=new THREE.MeshLambertMaterial({color:16776960,emissing:0,transparent:!0,opacity:1}),this.SelEffectTweenAlpha1=null,this.SelEffectTweenAlpha0=null,this.SelPlane=null,this.SelMaterialPlane=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:1}),this.SelEffectTweenAlphaPlane1=null,this.SelEffectTweenAlphaPlane0=null,this.mousePoint=new THREE.Vector2(0,0),this.domContainer=e,this.controlDom=t,this.init()}return e.prototype.init=function(){Detector.webgl?this.renderer=new THREE.WebGLRenderer({antialias:!0}):this.renderer=new THREE.CanvasRenderer({antialias:!0}),this.lookatTween=new TWEEN.Tween(this.lookatVector3),this.scene=new THREE.Scene,this.planeScene=new THREE.Scene,this.labelScene=new THREE.Scene,this.createPerspective(),this.defalutCameraTween=new TWEEN.Tween(this.curCameraPosition),this.perspectiveTween=new TWEEN.Tween(this.perspectiveControlSet),this.createOrthographic(),this.createLights(),this.createMeshSel(),this.renderer.setClearColor(15856375),this.renderer.setSize(V_WIDTH,V_HEIGHT),this.renderer.autoClear=!1,this.domContainer.appendChild(this.renderer.domElement)},e.prototype.lookatYTweento=function(e){var t=this;t.is3D&&(t.lookatVector3.copy(t.perspectiveControl.target),t.lookatTween.to({y:e},500).onUpdate(function(e){t.perspectiveControl.target.copy(this),t.perspectiveControl.update()}),t.lookatTween.start())},e.prototype.createOrthographic=function(){this.labelCamera=new THREE.OrthographicCamera(V_WIDTH/-2,V_WIDTH/2,V_HEIGHT/2,V_HEIGHT/-2,-FAER,2*FAER),this.labelCamera.position.z=10},e.prototype.createPerspective=function(){this.camera=new THREE.PerspectiveCamera(FOR,V_WIDTH/V_HEIGHT,NEAR,FAER),this.camera.up.set(0,1,0),this.camera.lookAt(new THREE.Vector3(0,0,0)),this.camera.position.z=1200;var e=new THREE.OrbitControls(this.camera,this.controlDom);e.maxPolarAngle=Math.PI/2,e.minPolarAngle=0,e.minDistance=20,e.minDistance=100,e.maxDistance=5e4,e.maxDistance=1/0,e.enableKeys=!1,this.perspectiveControl=e,this.cameraControls.push(e)},e.prototype.createLights=function(){var e=new THREE.AmbientLight(16777215,.65);this.scene.add(e);var t=new THREE.DirectionalLight(16777215,.4);t.color.setHSL(.1,1,.95),t.position.set(1,1.75,0),t.position.multiplyScalar(60),this.scene.add(t)},e.prototype.zoomIn=function(){for(var e=0;e<this.cameraControls.length;e++){var t=this.cameraControls[e];t.zoomIn()}},e.prototype.zoomAway=function(){for(var e=0;e<this.cameraControls.length;e++){var t=this.cameraControls[e];t.zoomOut()}},e.prototype.enabledRotateUp=function(e){for(var t=0;t<this.cameraControls.length;t++){var n=this.cameraControls[t];n.enableRotateUp=e}},e.prototype.enabledRotateLeft=function(e){for(var t=0;t<this.cameraControls.length;t++){var n=this.cameraControls[t];n.enableRotateLeft=e}},e.prototype.backgroundSet=function(e){e=e||15856375,this.renderer&&this.renderer.setClearColor(e)},e.prototype.enabledMapMove=function(e){for(var t=0;t<this.cameraControls.length;t++){var n=this.cameraControls[t];n.enablePan=e}},e.prototype.render=function(){this.curArchite&&this.curArchite.updateBillBoards(this.camera),this.renderer.clear(),this.is3D?(this.renderer.render(this.scene,this.camera),this.renderer.clearDepth(),this.renderer.render(this.labelScene,this.labelCamera)):(this.renderer.render(this.planeScene,this.camera),this.renderer.clearDepth(),this.renderer.render(this.labelScene,this.labelCamera))},e.prototype.enabled3D=function(e){var t=this;t.SelMesh&&(t.SelMesh.material=t.SelMesh.defaultMaterial,t.SelMesh=null),t.SelPlane&&(t.SelPlane.material=t.SelPlane.defaultMaterial,t.SelPlane=null),e?(t.is3D=e,t.curCameraPosition.copy(t.camera.position),t.perspectiveControl.maxPolarAngle=t.maxPolarAngleInit,t.defalutCameraTween.stop(),t.defalutCameraTween.to({x:t.defalutCameraPosition.x,y:t.defalutCameraPosition.y,z:t.defalutCameraPosition.z},500).onUpdate(function(){t.camera.position.copy(this),t.perspectiveControl.update()}),t.defalutCameraTween.start()):(t.defalutCameraPosition.copy(this.camera.position),t.perspectiveTween.stop(),t.perspectiveControlSet.maxPolarAngle=Math.PI/2,t.perspectiveTween.to({maxPolarAngle:0},1e3).onUpdate(function(){t.perspectiveControl.maxPolarAngle=this.maxPolarAngle,t.perspectiveControl.update()}).onComplete(function(){t.is3D=e,t.curArchite&&t.curArchite.display2DPattern()}),t.perspectiveTween.start())},e.prototype.pubPointEnabled=function(e){this.curArchite&&this.curArchite.enabledFloorsPubPoints(e)},e.prototype.funcAreasLabelEnabled=function(e){this.curArchite&&this.curArchite.enabledFloorsLabel(e)},e.prototype.updateMapByArchiteBase=function(e){this.curArchite=e,e&&(this.defalutCameraPosition.set(386,1367,-1269),this.camera.position.copy(this.defalutCameraPosition),this.perspectiveControl.update(),this.scene.add(e.floorGround),this.planeScene.add(e.floorGround2D),this.scene.add(e.ArchiteMesh),this.planeScene.add(e.ArchiteMesh2D),this.labelScene.add(e.ArchiteSprite),e.showFloorsMeshByID(e.getDefaultFoolr()),e.enabledFloorsPubPoints(!0),e.enabledFloorsLabel(!0))},e.prototype.resize=function(){this.renderer.setSize(V_WIDTH,V_HEIGHT),this.camera.aspect=V_WIDTH/V_HEIGHT,this.camera.updateProjectionMatrix(),this.labelCamera.left=V_WIDTH/-2,this.labelCamera.right=V_WIDTH/2,this.labelCamera.top=V_HEIGHT/2,this.labelCamera.bottom=V_HEIGHT/-2,this.labelCamera.updateProjectionMatrix()},e.prototype.createMeshSel=function(){var e=this;this.SelEffectTweenAlpha1=new TWEEN.Tween(this.SelMaterial),this.SelEffectTweenAlpha0=new TWEEN.Tween(this.SelMaterial),this.SelEffectTweenAlpha1.to({opacity:1},500),this.SelEffectTweenAlpha0.to({opacity:0},500).onComplete(function(){e.SelEffectTweenAlpha1.start()}),this.SelEffectTweenAlphaPlane1=new TWEEN.Tween(this.SelMaterialPlane),this.SelEffectTweenAlphaPlane0=new TWEEN.Tween(this.SelMaterialPlane),this.SelEffectTweenAlphaPlane1.to({opacity:1},500),this.SelEffectTweenAlphaPlane0.to({opacity:0},500).onComplete(function(){e.SelEffectTweenAlphaPlane1.start()}),this.raycaster=new THREE.Raycaster,this.controlDom.addEventListener("mousedown",function(t){e.meshSelDownPoint.x=t.clientX,e.meshSelDownPoint.y=t.clientY}),this.controlDom.addEventListener("mouseup",function(t){Math.abs(e.meshSelDownPoint.x-t.clientX)>3||Math.abs(e.meshSelDownPoint.y-t.clientY)>3?e.isSel=!1:e.isSel=!0}),this.controlDom.addEventListener("click",function(t){if(e.isSel&&e.curArchite&&e.selectEnabled){if(!e.curArchite.ArchiteMesh)return;e.mousePoint.x=t.clientX/V_WIDTH*2-1,e.mousePoint.y=2*-(t.clientY/V_HEIGHT)+1,e.raycaster.setFromCamera(e.mousePoint,e.camera);var n=[];n=e.is3D?e.raycaster.intersectObjects(e.curArchite.ArchiteMesh.children,!0):e.raycaster.intersectObjects(e.curArchite.ArchiteMesh2D.children,!0),n.length&&e.selMeshHandler(n[0])}})},e.prototype.searchFuncArea=function(e){if(this.curArchite){var t=this.curArchite.search(e);t?this.is3D?this.selMeshHandler({object:t.mesh.children[0]}):this.selMeshHandler({object:t.plane.children[0]}):msg("未找到："+e)}else msg("不存在建筑供查询！")},e.prototype.selMeshHandler=function(e){if(e&&e.object){var t=e.object;this.is3D?(this.SelMesh&&(this.SelMesh.material=this.SelMesh.defaultMaterial,this.SelMesh=null),this.SelMesh=t,t.material=this.SelMaterial,this.SelMaterial.opacity=1,this.SelEffectTweenAlpha0.start()):(this.SelPlane&&(this.SelPlane.material=this.SelPlane.defaultMaterial,this.SelPlane=null),this.SelPlane=t,t.material=this.SelMaterialPlane,this.SelMaterialPlane.opacity=1,this.SelEffectTweenAlphaPlane0.start())}},e}();Rect.prototype.isCollide=function(e){return!(e.br[0]<this.tl[0]||e.tl[0]>this.br[0]||e.br[1]<this.tl[1]||e.tl[1]>this.br[1])};var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,n,o;e=e||{},t=void 0!==e.parent?e.parent:document.body,n=void 0!==e.id?e.id:"oldie",o=Detector.getWebGLErrorMessage(),o.id=n,t.appendChild(o)}};"object"==typeof module&&(module.exports=Detector),THREE.OrbitControls=function(e,t){function n(){return 2*Math.PI/60/60*F.autoRotateSpeed}function o(){return Math.pow(.95,F.zoomSpeed)}function i(e){F.enableRotateLeft&&(N.theta-=e)}function a(e){F.enableRotateUp&&(N.phi-=e)}function r(e){F.object instanceof THREE.PerspectiveCamera?z/=e:F.object instanceof THREE.OrthographicCamera?(F.object.zoom=Math.max(F.minZoom,Math.min(F.maxZoom,F.object.zoom*e)),F.object.updateProjectionMatrix(),U=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),F.enableZoom=!1)}function s(e){F.object instanceof THREE.PerspectiveCamera?z*=e:F.object instanceof THREE.OrthographicCamera?(F.object.zoom=Math.max(F.minZoom,Math.min(F.maxZoom,F.object.zoom/e)),F.object.updateProjectionMatrix(),U=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),F.enableZoom=!1)}function l(e){Z.set(e.clientX,e.clientY)}function h(e){Q.set(e.clientX,e.clientY)}function c(e){X.set(e.clientX,e.clientY)}function u(e){B.set(e.clientX,e.clientY),Y.subVectors(B,Z);var t=F.domElement===document?F.domElement.body:F.domElement;i(2*Math.PI*Y.x/t.clientWidth*F.rotateSpeed),a(2*Math.PI*Y.y/t.clientHeight*F.rotateSpeed),Z.copy(B),F.update()}function d(e){J.set(e.clientX,e.clientY),$.subVectors(J,Q),$.y>0?r(o()):$.y<0&&s(o()),Q.copy(J),F.update()}function p(e){K.set(e.clientX,e.clientY),q.subVectors(K,X),ne(q.x,q.y),X.copy(K),F.update()}function m(e){}function f(e){var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?s(o()):t<0&&r(o()),F.update()}function E(e){switch(e.keyCode){case F.keys.UP:ne(0,F.keyPanSpeed),F.update();break;case F.keys.BOTTOM:ne(0,-F.keyPanSpeed),F.update();break;case F.keys.LEFT:ne(F.keyPanSpeed,0),F.update();break;case F.keys.RIGHT:ne(-F.keyPanSpeed,0),F.update()}}function b(e){Z.set(e.touches[0].pageX,e.touches[0].pageY)}function g(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+n*n);Q.set(0,o)}function w(e){X.set(e.touches[0].pageX,e.touches[0].pageY)}function y(e){B.set(e.touches[0].pageX,e.touches[0].pageY),Y.subVectors(B,Z);var t=F.domElement===document?F.domElement.body:F.domElement;i(2*Math.PI*Y.x/t.clientWidth*F.rotateSpeed),a(2*Math.PI*Y.y/t.clientHeight*F.rotateSpeed),Z.copy(B),F.update()}function T(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);J.set(0,i),$.subVectors(J,Q),$.y>0?s(o()):$.y<0&&r(o()),Q.copy(J),F.update()}function v(e){K.set(e.touches[0].pageX,e.touches[0].pageY),q.subVectors(K,X),ne(q.x,q.y),X.copy(K),F.update()}function A(e){}function P(e){if(F.enabled!==!1){if(e.preventDefault(),e.button===F.mouseButtons.PAN){if(F.enableRotate===!1)return;l(e),G=I.ROTATE}else if(e.button===F.mouseButtons.ZOOM){if(F.enableZoom===!1)return;h(e),G=I.DOLLY}else if(e.button===F.mouseButtons.ORBIT){if(F.enablePan===!1)return;c(e),G=I.PAN}G!==I.NONE&&(document.addEventListener("mousemove",M,!1),document.addEventListener("mouseup",H,!1),document.addEventListener("mouseout",H,!1),F.dispatchEvent(x))}}function M(e){if(F.enabled!==!1)if(e.preventDefault(),G===I.ROTATE){if(F.enableRotate===!1)return;u(e)}else if(G===I.DOLLY){if(F.enableZoom===!1)return;d(e)}else if(G===I.PAN){if(F.enablePan===!1)return;p(e)}}function H(e){F.enabled!==!1&&(m(e),document.removeEventListener("mousemove",M,!1),document.removeEventListener("mouseup",H,!1),document.removeEventListener("mouseout",H,!1),F.dispatchEvent(j),G=I.NONE)}function D(e){F.enabled===!1||F.enableZoom===!1||G!==I.NONE&&G!==I.ROTATE||(e.preventDefault(),e.stopPropagation(),f(e),F.dispatchEvent(x),F.dispatchEvent(j))}function S(e){F.enabled!==!1&&F.enableKeys!==!1&&F.enablePan!==!1&&E(e)}function R(e){if(F.enabled!==!1){switch(e.touches.length){case 1:if(F.enableRotate===!1)return;b(e),G=I.TOUCH_ROTATE;break;case 2:if(F.enableZoom===!1)return;g(e),G=I.TOUCH_DOLLY;break;case 3:if(F.enablePan===!1)return;w(e),G=I.TOUCH_PAN;break;default:G=I.NONE}G!==I.NONE&&F.dispatchEvent(x)}}function C(e){if(F.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 2:if(F.enableRotate===!1)return;if(G!==I.TOUCH_ROTATE)return;y(e);break;case 1:if(F.enableZoom===!1)return;if(G!==I.TOUCH_DOLLY)return;T(e);break;case 3:if(F.enablePan===!1)return;if(G!==I.TOUCH_PAN)return;v(e);break;default:G=I.NONE}}function O(e){F.enabled!==!1&&(A(e),F.dispatchEvent(j),G=I.NONE)}function L(e){e.preventDefault()}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.enableRotateUp=!0,this.enableRotateLeft=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return phi},this.getAzimuthalAngle=function(){return theta},this.reset=function(){F.target.copy(F.target0),F.object.position.copy(F.position0),F.object.zoom=F.zoom0,F.object.updateProjectionMatrix(),F.dispatchEvent(_),F.update(),G=I.NONE},this.update=function(){var t=new THREE.Vector3,o=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),a=o.clone().inverse(),r=new THREE.Vector3,s=new THREE.Quaternion;return function(){var e=F.object.position;return t.copy(e).sub(F.target),t.applyQuaternion(o),k.setFromVector3(t),F.autoRotate&&G===I.NONE&&i(n()),k.theta+=N.theta,k.phi+=N.phi,k.theta=Math.max(F.minAzimuthAngle,Math.min(F.maxAzimuthAngle,k.theta)),k.phi=Math.max(F.minPolarAngle,Math.min(F.maxPolarAngle,k.phi)),k.makeSafe(),k.radius*=z,k.radius=Math.max(F.minDistance,Math.min(F.maxDistance,k.radius)),F.target.add(W),t.setFromSpherical(k),t.applyQuaternion(a),e.copy(F.target).add(t),F.object.lookAt(F.target),F.enableDamping===!0?(N.theta*=1-F.dampingFactor,N.phi*=1-F.dampingFactor):N.set(0,0,0),z=1,W.set(0,0,0),!!(U||r.distanceToSquared(F.object.position)>V||8*(1-s.dot(F.object.quaternion))>V)&&(F.dispatchEvent(_),r.copy(F.object.position),s.copy(F.object.quaternion),U=!1,!0)}}(),this.dispose=function(){F.domElement.removeEventListener("contextmenu",L,!1),F.domElement.removeEventListener("mousedown",P,!1),F.domElement.removeEventListener("mousewheel",D,!1),F.domElement.removeEventListener("MozMousePixelScroll",D,!1),F.domElement.removeEventListener("touchstart",R,!1),F.domElement.removeEventListener("touchend",O,!1),F.domElement.removeEventListener("touchmove",C,!1),document.removeEventListener("mousemove",M,!1),document.removeEventListener("mouseup",H,!1),document.removeEventListener("mouseout",H,!1),window.removeEventListener("keydown",S,!1)};var F=this,_={type:"change"},x={type:"start"},j={type:"end"},I={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},G=I.NONE,V=1e-6,k=new THREE.Spherical,N=new THREE.Spherical;this.curSpherical=k,this.deltaSpherical=N;var z=1,W=new THREE.Vector3,U=!1,Z=new THREE.Vector2,B=new THREE.Vector2,Y=new THREE.Vector2,X=new THREE.Vector2,K=new THREE.Vector2,q=new THREE.Vector2,Q=new THREE.Vector2,J=new THREE.Vector2,$=new THREE.Vector2,ee=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),W.add(e)}}(),te=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,1),e.multiplyScalar(t),W.add(e)}}(),ne=function(){var e=new THREE.Vector3;return function(t,n){var o=F.domElement===document?F.domElement.body:F.domElement;if(F.object instanceof THREE.PerspectiveCamera){var i=F.object.position;e.copy(i).sub(F.target);var a=e.length();a*=Math.tan(F.object.fov/2*Math.PI/180),ee(2*t*a/o.clientHeight,F.object.matrix),te(2*n*a/o.clientHeight,F.object.matrix)}else F.object instanceof THREE.OrthographicCamera?(ee(t*(F.object.right-F.object.left)/F.object.zoom/o.clientWidth,F.object.matrix),
te(n*(F.object.top-F.object.bottom)/F.object.zoom/o.clientHeight,F.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),F.enablePan=!1)}}(),oe={persScale:1,orthZoom:1},ie=new TWEEN.Tween(oe);this.zoomIn=function(){var e=o();if(F.object instanceof THREE.PerspectiveCamera){var t=z*e;oe.persScale=z,ie.to({persScale:t},300),ie.onUpdate(function(){z=this.persScale,F.update()}),ie.start()}else if(F.object instanceof THREE.OrthographicCamera){F.object.zoom=Math.max(F.minZoom,Math.min(F.maxZoom,F.object.zoom/e)),F.object.updateProjectionMatrix(),U=!0;var n=Math.max(F.minZoom,Math.min(F.maxZoom,F.object.zoom/e));oe.orthZoom=F.object.zoom,ie.to({orthZoom:n},300),ie.onUpdate(function(){F.object.zoom==this.orthZoom,F.object.updateProjectionMatrix(),U=!0,F.update()}),ie.start()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),F.enableZoom=!1},this.zoomOut=function(){var e=o();if(F.object instanceof THREE.PerspectiveCamera){var t=z/e;oe.persScale=z,ie.to({persScale:t},300),ie.onUpdate(function(){z=this.persScale,F.update()}),ie.start()}else if(F.object instanceof THREE.OrthographicCamera){var n=Math.max(F.minZoom,Math.min(F.maxZoom,F.object.zoom*dollyScale));oe.orthZoom=F.object.zoom,ie.to({orthZoom:n},300),ie.onUpdate(function(){F.object.zoom==this.orthZoom,F.object.updateProjectionMatrix(),U=!0,F.update()}),ie.start()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),F.enableZoom=!1},F.domElement.addEventListener("contextmenu",L,!1),F.domElement.addEventListener("mousedown",P,!1),F.domElement.addEventListener("mousewheel",D,!1),F.domElement.addEventListener("MozMousePixelScroll",D,!1),F.domElement.addEventListener("touchstart",R,!1),F.domElement.addEventListener("touchend",O,!1),F.domElement.addEventListener("touchmove",C,!1),window.addEventListener("keydown",S,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.constraint.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.constraint.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor=e}}});