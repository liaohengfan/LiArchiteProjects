function getIconUrlByType(t){var e=_.findWhere(ICON_TYPE_CHECK,{type:t});return e?ICON_ASSET_BASE+e.ico:""}function getPositionByLonLat(t,e,i){var a=new THREE.Vector3;return a.x=i*Math.sin(t)*Math.sin(e),a.y=i*Math.cos(t),a.z=i*Math.sin(t)*Math.cos(e),a}function Rect(t,e,i,a){this.tl=[t||0,e||0],this.br=[i||0,a||0]}function updateBillBoards(t,e){for(var i=Number(V_WIDTH>>1),a=Number(V_HEIGHT>>1),o=0;o<t.children.length;o++){var r=t.children[o],n=new THREE.Vector3(r.lockX,r.lockZ,-r.lockY);n.applyProjection(e);var s=Math.round(n.x*i),h=Math.round(n.y*a),l=Math.round(n.z*a);r.position.set(s,h,l);for(var c=!0,u=5,p=0;p<o;p++){var d=r.material.map.image;if(!d){c=!1;break}if(!r.width||!r.height){c=!1;break}var f=r.width/2,w=r.height/2,b=new Rect(r.position.x-f,r.position.y-w,r.position.x+w,r.position.y+w),g=t.children[p],v=g.position,y=g.width/2,m=g.height/2,S=new Rect(v.x-y,v.y-m,v.x+m,v.y+m);if(g.visible&&b.isCollide(S)){c=!1;break}if(b.tl[0]-=u,b.tl[1]-=u,S.tl[0]-=u,S.tl[1]-=u,0==r.visible&&b.isCollide(S)){c=!1;break}}r.visible=c}}function parseVec2Points(t){for(var e=[],i=0;i<t.length;i+=2){var a=new THREE.Vector2(t[i],t[i+1]);if(i>0){var o=e[e.length-1];a.x==o.x&&a.y==o.y||e.push(a)}else e.push(a)}return e}function getLabelTexture(t){var e=document.createElement("canvas"),i=e.getContext("2d");i.strokeStyle="#FFFFFF",i.fillStyle="#000000",i.lineWidth=4,i.font="32px Microsoft Yahei",i.fillText(t,10,40);var a=new THREE.Texture(e);return a}function makeTextSprite(t,e){void 0===e&&(e={});var i=e.hasOwnProperty("fontface")?e.fontface:"Arial",a=e.hasOwnProperty("fontsize")?e.fontsize:18,o=e.hasOwnProperty("borderThickness")?e.borderThickness:2,r=e.hasOwnProperty("borderColor")?e.borderColor:{r:1,g:1,b:1,a:1},n=(e.hasOwnProperty("backgroundColor")?e.backgroundColor:{r:255,g:255,b:255,a:1},e.hasOwnProperty("color")?e.color:"#000000"),s=(new THREE.Vector2(0,0),document.createElement("canvas")),h=s.getContext("2d");h.font=a+"px "+i;var l=h.measureText(t);h.strokeStyle="rgba("+r.r+","+r.g+","+r.b+","+r.a+")",h.fillStyle=n,h.strokeStyle="#FFFFFF",h.fillStyle="#000000",IsPC()?h.lineWidth=12:h.lineWidth=6,h.strokeText(t,o,a+o),h.fillText(t,o,a+o);var c=new THREE.Texture(s);c.needsUpdate=!0;var u=new THREE.SpriteMaterial({map:c,useScreenCoordinates:!1}),p=new THREE.Sprite(u);return p.defaultMaterial=u,p.scale.set(100,50,1),p.width=l.width/2,p.height=.8*a,p}function imageAddBorderTexture(t){var e=document.createElement("canvas");document.body.appendChild(e);var i=e.getContext("2d");i.drawImage(t,0,0);var a=new THREE.Texture(e);return a}function getDataMesh(t,e,i){void 0===e&&(e=1),void 0===i&&(i=16777215);var a={outline3D:new THREE.Object3D,outline:new THREE.Object3D,outline2D:new THREE.Object3D};if(t=t||{},t.Outline=t.Outline||[],t.Outline)for(var o={amount:10,bevelEnabled:!1,curveSegments:1,steps:1},r=0;r<t.Outline.length;r++){var n=t.Outline[r];n=n||[];for(var s=0;s<n.length;s++){var h=parseVec2Points(n[s]),l=new THREE.Shape(h),c=new THREE.ShapeGeometry(l),u=new THREE.MeshBasicMaterial({color:i||16777215}),p=new THREE.Mesh(c,u);p.defaultMaterial=u,p.selMaterial=null,o.amount=10*(t.High||e);var d=new THREE.ExtrudeGeometry(l,o),f=new THREE.MeshLambertMaterial({color:i||16777215,side:THREE.DoubleSide}),w=new THREE.Mesh(d,f);w.defaultMaterial=f,w.selMaterial=null,l.autoClose=!0;var b=new THREE.LineBasicMaterial({color:10066329,linewidth:1}),g=new THREE.Line(l.createPointsGeometry(10),b);g.defaultMaterial=b,i+=1,a.outline.add(g),a.outline3D.add(w),a.outline2D.add(p)}}return a}function getLimitHeightDataMesh(t,e,i){void 0===e&&(e=1),void 0===i&&(i=16777215);var a={outline3D:new THREE.Object3D,outline:new THREE.Object3D,outline2D:new THREE.Object3D};if(t=t||{},t.Outline=t.Outline||[],t.Outline)for(var o={amount:10,bevelEnabled:!1,curveSegments:1,steps:1},r=0;r<t.Outline.length;r++){var n=t.Outline[r];n=n||[];for(var s=0;s<n.length;s++){var h=parseVec2Points(n[s]),l=new THREE.Shape(h),c=new THREE.ShapeGeometry(l),u=new THREE.MeshBasicMaterial({color:i||16777215}),p=new THREE.Mesh(c,u);p.defaultMaterial=u,o.amount=10*e;var d=new THREE.MeshLambertMaterial({color:i||16777215}),f=new THREE.ExtrudeGeometry(l,o),w=new THREE.Mesh(f,d);w.defaultMaterial=d,l.autoClose=!0;var b=new THREE.LineBasicMaterial({color:10066329,linewidth:1}),g=new THREE.Line(l.createPointsGeometry(10),b);g.defaultMaterial=b,i+=1,a.outline.add(g),a.outline3D.add(w),a.outline2D.add(p)}}return a}function meshChangeOpacity(t,e){function i(t){if(t&&"Mesh"==t.type&&t.defaultMaterial&&(t.defaultMaterial.transparent=a,t.defaultMaterial.opacity=e),t&&"Sprite"==t.type&&t.defaultMaterial&&(t.defaultMaterial.transparent=a,t.defaultMaterial.opacity=e),t&&"Line"==t.type&&t.defaultMaterial&&(t.defaultMaterial.transparent=a,t.defaultMaterial.opacity=e),t.children&&t.children.length)for(var o=0;o<t.children.length;o++){var r=t.children[o];i(r)}}e=e||1;var a=!0;e>=1&&(a=!1),t&&i(t)}var ArchiteBase=function(){function t(t,e){this.archite_show=!0,this.archite_name="",this.archite_id="",this.is3D=!0,this.showall=!1,this.oriData=null,this.ArchiteName="",this.ArchiteOutLine=[],this.ArchiteID="",this.ArchiteMesh=null,this.ArchiteMesh2D=null,this.floorGround=null,this.floorGround2D=null,this.ArchiteSprite=null,this.ArchiteIcon=null,this.ArchiteLabel=null,this.architeFloors=[],this.buildingOutLine=null,this.buildingOutLineShow=!1,this.pubPointShow=!0,this.funcareaLabelShow=!0,this.oriData=t,this.ArchiteName=this.oriData.building.Name,this.ArchiteOutLine=this.oriData.building.Outline,this.ArchiteID=this.oriData.building._id,this.archite_id=t._id,this.archite_name=t.Name,this.is3D=e,this.oriData.Floors=this.oriData.Floors||[],this.floorGround=new THREE.Object3D,this.floorGround2D=new THREE.Object3D,this.ArchiteMesh=new THREE.Object3D,this.ArchiteMesh2D=new THREE.Object3D,this.ArchiteSprite=new THREE.Object3D,this.ArchiteIcon=new THREE.Object3D,this.ArchiteLabel=new THREE.Object3D,this.ArchiteSprite.add(this.ArchiteIcon),this.ArchiteSprite.add(this.ArchiteLabel),this.floorGround.rotateX(-(Math.PI/2)),this.floorGround2D.rotateX(-(Math.PI/2)),this.ArchiteMesh.rotateX(-(Math.PI/2)),this.ArchiteMesh2D.rotateX(-(Math.PI/2))}return t.prototype.parseBuildingOutLine=function(){this.buildingOutLine=getDataMesh(this.oriData.building).outline3D,this.buildingOutLine.visible=this.buildingOutLineShow,this.ArchiteMesh.add(this.buildingOutLine)},t.prototype.enabledBuildingOutLine=function(t){this.buildingOutLine.visible=t,this.buildingOutLineShow=t},t.prototype.getDefaultFoolr=function(){return this.oriData.building.DefaultFloor},t.prototype.getFloorY=function(t){var e=null,i=0;return t>0?(e=_.filter(this.oriData.Floors,function(e){return e._id<t&&e._id>=0}),_.map(e,function(t){i+=t.High||0}),i):(e=_.filter(this.oriData.Floors,function(e){return e._id>=t&&e._id<=0}),_.map(e,function(t){i-=t.High||0}),i)},t.prototype.enabeld3D=function(t){this.is3D=t,_.map(this.architeFloors,function(e){e.is3D=t})},t.prototype.display2DPattern=function(){var t=this,e=_.filter(t.architeFloors,function(t){return 1==t.showStuts}),i=_.filter(t.architeFloors,function(t){return 2==t.showStuts});if(e.length){e=_.sortBy(e,function(t){return t._id||-100});var a=_.first(e);try{a.stutsChange(1)}catch(t){}var o=_.rest(e);_.map(o,function(t){try{t.stutsChange(0)}catch(t){}}),_.map(i||[],function(t){try{t.stutsChange(0)}catch(t){}})}},t.prototype.showFloorsMeshByID=function(t,e){void 0===e&&(e=!1);var i=null;i=_.findWhere(this.architeFloors,{archite_id:t});var a=null;if(a=_.reject(this.architeFloors,function(e){return e.archite_id==t}),a&&a.length)for(var o=0;o<a.length;o++){var r=a[o];r&&(e?r.stutsChange(0):r.stutsChange(2))}if(i)i.stutsChange(1);else{if(i=this.createFloors(t),!i)return;this.architeFloors.push(i),this.ArchiteMesh.add(i.getFuncAreasMesh(!0)),this.ArchiteMesh2D.add(i.getFuncAreasMesh(!1)),this.floorGround.add(i.getFloorGround(!0)),this.floorGround2D.add(i.getFloorGround(!1)),this.ArchiteIcon.add(i.getPubPoints(this.pubPointShow)),this.ArchiteIcon.add(i.getFuncAreasLabel(this.funcareaLabelShow))}return i},t.prototype.search=function(t){var e=_.filter(this.oriData.Floors||[],function(e){return!!_.findWhere(e.FuncAreas||[],{Name:t})});if(!e||!e.length)return null;var i=e[0],a=this.showFloorsMeshByID(i._id);if(!a)return null;var o=a.searchFuncArea(t);return o?o:null},t.prototype.showAllFloors=function(){var t=this;_.map(t.oriData.Floors||[],function(e,i){var a=_.findWhere(t.architeFloors,{archite_id:e._id});if(a);else{if(a=t.createFloors(e._id),!a)return;t.architeFloors.push(a),t.ArchiteMesh.add(a.getFuncAreasMesh(!0)),t.ArchiteMesh2D.add(a.getFuncAreasMesh(!1)),t.floorGround.add(a.getFloorGround(!0)),t.floorGround2D.add(a.getFloorGround(!1)),t.ArchiteIcon.add(a.getPubPoints(t.pubPointShow)),t.ArchiteIcon.add(a.getFuncAreasLabel(t.funcareaLabelShow))}0==i?a.stutsChange(1):a.stutsChange(2)})},t.prototype.updateBillBoards=function(t){if(t&&(this.pubPointShow||this.funcareaLabelShow)){var e=new THREE.Matrix4;e.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);for(var i=0;i<this.architeFloors.length;i++){var a=this.architeFloors[i];0!=a.showStuts&&(this.pubPointShow&&a.updateSpritesPosition(e),this.funcareaLabelShow&&a.updateLabelsPosition(e))}}},t.prototype.enabledFloorsPubPoints=function(t){this.pubPointShow=t;for(var e=_.where(this.architeFloors,{archite_show:!0}),i=0;i<e.length;i++){var a=e[i];this.ArchiteIcon.add(a.getPubPoints(t))}},t.prototype.enabledFloorsLabel=function(t){this.funcareaLabelShow=t;for(var e=_.where(this.architeFloors,{archite_show:!0}),i=0;i<e.length;i++){var a=e[i];this.ArchiteIcon.add(a.getFuncAreasLabel(t))}},t.prototype.createFloors=function(t){var e=null;if(e=_.findWhere(this.oriData.Floors||[],{_id:t})){var i=this.getFloorY(t),a=new ArchiteFloor(e,80*i);return a}},t}(),ArchiteData=function(){function t(t,e){this.ui=null,this.webgl=null,this.is3D=!0,this.ui=t,this.webgl=e}return t.prototype.getMapsbyAjax=function(t,e){var i=this;$.ajax({type:"GET",url:t,dataType:"json",data:e,success:function(t){i.parseMapsData(t)}})},t.prototype.parseMapsData=function(t){var e=new ArchiteBase(t.data,this.is3D);this.webgl.updateMapByArchiteBase(e),this.ui.updataUIByArchiteBase(e)},t}(),ArchiteFuncArea=function(){function t(t,e,i){this.archite_show=!0,this.archite_name="",this.archite_id="",this.mesh=null,this.plane=null,this.outLine=null,this.archite_id=t._id,this.archite_name=t.Name;var a=getDataMesh(t,e,i);this.mesh=a.outline3D,this.outLine=a.outline,this.plane=a.outline2D}return t}(),ArchiteFloor=function(){function t(t,e){this.showStuts=1,this.archite_show=!0,this.archite_name="",this.archite_id="",this.floorData=null,this.is3D=!0,this.yAxis=0,this.floorHigh=0,this.PubPoints=null,this.floorGround=null,this.floorGround2D=null,this.funcAreas=[],this.funcAreaMesh=null,this.funcAreaMesh2D=null,this.funcAreasLabels=null,this.floorData=t,this.archite_id=t._id,this.archite_name=t.Name,this.yAxis=e,this.floorHigh=10*t.High}return t.prototype.applyStuts=function(t,e,i){t&&(t.visible=e,e&&meshChangeOpacity(t,i))},t.prototype.updateLabelsPosition=function(t){this.funcAreasLabels&&updateBillBoards(this.funcAreasLabels,t)},t.prototype.updateSpritesPosition=function(t){this.PubPoints&&updateBillBoards(this.PubPoints,t)},t.prototype.stutsChange=function(t){if(t!=this.showStuts)switch(this.showStuts=t,this.showStuts){case 1:this.applyStuts(this.floorGround,!0,1),this.applyStuts(this.funcAreaMesh,!0,1),this.applyStuts(this.floorGround2D,!0,1),this.applyStuts(this.funcAreaMesh2D,!0,1),this.applyStuts(this.PubPoints,!0,1),this.applyStuts(this.funcAreasLabels,!0,1);break;case 2:this.applyStuts(this.floorGround,!0,.1),this.applyStuts(this.funcAreaMesh,!0,.1),this.applyStuts(this.floorGround2D,!0,.1),this.applyStuts(this.funcAreaMesh2D,!0,.1),this.applyStuts(this.PubPoints,!0,.1),this.applyStuts(this.funcAreasLabels,!0,.1);break;default:this.applyStuts(this.floorGround,!1,.1),this.applyStuts(this.funcAreaMesh,!1,.1),this.applyStuts(this.floorGround2D,!1,.1),this.applyStuts(this.funcAreaMesh2D,!1,.1),this.applyStuts(this.PubPoints,!1,.1),this.applyStuts(this.funcAreasLabels,!1,.1)}},t.prototype.getPubPoints=function(t){if(this.PubPoints)return this.PubPoints.visible=t,this.PubPoints;if(this.PubPoints=new THREE.Object3D,this.PubPoints.position.z=this.yAxis,this.PubPoints.visible=t,this.floorData.PubPoint){this.floorData.PubPoint=this.floorData.PubPoint||[];var e=this.floorData.High;e*=10;for(var i=this.yAxis+e,a=0;a<this.floorData.PubPoint.length;a++){var o=this.floorData.PubPoint[a],r=o.Outline[0][0],n=new THREE.Vector3(r[0]||0,r[1],e),s=getIconUrlByType(o.Type),h=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(s),color:16777215}),l=new THREE.Sprite(h);l.lockX=n.x,l.lockY=n.y,l.lockZ=i,l.defaultMaterial=h,l.scale.set(24,24,1),l.width=24,l.height=24,l.position.copy(n),this.PubPoints.add(l)}}return this.PubPoints},t.prototype.getFloorGround=function(t){if(void 0===t&&(t=!0),this.floorGround)return t?this.floorGround:this.floorGround2D;if(this.floorGround=new THREE.Object3D,this.floorGround.position.z=this.yAxis-10,this.floorGround2D=new THREE.Object3D,this.floorGround2D.position.z=this.yAxis+this.floorHigh-1,this.floorData.Outline){var e=getLimitHeightDataMesh(this.floorData,1,16777215);this.floorGround.add(e.outline3D),this.floorGround2D.add(e.outline2D)}return t?this.floorGround:this.floorGround2D},t.prototype.getFuncAreasMesh=function(t){if(this.funcAreaMesh)return t?this.funcAreaMesh:this.funcAreaMesh2D;if(this.funcAreaMesh=new THREE.Object3D,this.funcAreaMesh.position.z=this.yAxis,this.funcAreaMesh2D=new THREE.Object3D,this.funcAreaMesh2D.position.z=this.yAxis+this.floorHigh,this.floorData.FuncAreas)for(var e=this.floorData.FuncAreas,i=this.floorData.High,a=0;a<e.length;a++){var o=[13237193,9947643,13224443],r=_.sample(o),n=new ArchiteFuncArea(e[a],i,r);this.funcAreaMesh.add(n.mesh),n.outLine.position.z=10*i,this.funcAreaMesh.add(n.outLine),this.funcAreaMesh2D.add(n.plane),this.funcAreas.push(n)}return t?this.funcAreaMesh:this.funcAreaMesh2D},t.prototype.searchFuncArea=function(t){var e=_.findWhere(this.funcAreas,{archite_name:t});return e},t.prototype.getFuncAreasLabel=function(t){if(this.funcAreasLabels)return this.funcAreasLabels.visible=t,this.funcAreasLabels;if(this.funcAreasLabels=new THREE.Object3D,this.funcAreasLabels.position.z=this.yAxis,this.funcAreasLabels.visible=t,this.floorData.FuncAreas){this.floorData.FuncAreas=this.floorData.FuncAreas||[];var e=this.floorData.High;e*=10;for(var i=this.yAxis+e,a=0;a<this.floorData.FuncAreas.length;a++){var o=this.floorData.FuncAreas[a],r=o.Center,n=new THREE.Vector3(r[0]||0,r[1],e),s=makeTextSprite(o.Name||"",{color:"#231815",fontsize:40,fontface:"Helvetica, MicrosoftYaHei "});s.lockX=n.x,s.lockY=n.y,s.lockZ=i,s.position.copy(n),this.funcAreasLabels.add(s)}}return this.funcAreasLabels},t}(),V_WIDTH=1280,V_HEIGHT=720,FOR=60,NEAR=10,FAER=1e4,PI2=2*Math.PI,ICON_ASSET_BASE="asset/PublicPointIco/",ICON_TYPE_CHECK=[{name:"ATM",type:"31003",ico:"ATM.png",en:""},{name:"残障洗手间",type:"11005",ico:"crippled.png",en:""},{name:"出入口",type:"31004",ico:"entry.png",en:""},{name:"扶梯",type:"21002",ico:"escalator.png",en:""},{name:"女洗手间",type:"11003",ico:"Female.png",en:""},{name:"问讯处",type:"31001",ico:"inquiry.png",en:""},{name:"直梯",type:"21003",ico:"lift.png",en:""},{name:"补妆间",type:"31002",ico:"Makeup.png",en:""},{name:"男洗手间",type:"11002",ico:"Male.png",en:""},{name:"母婴室",type:"11004",ico:"MomBaby.png",en:""},{name:"楼梯",type:"21001",ico:"stair.png",en:""},{name:"洗手间",type:"11001",ico:"toilet.png",en:""}],IsPC=function(){for(var t=navigator.userAgent,e=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"),i=!0,a=0;a<e.length;a++)if(t.indexOf(e[a])>0){i=!1;break}return i},msg=function(t){layer?layer.msg(t):alert(t)},ArchiteMain=function(){function t(t,e){if(!Detector.webgl)throw msg("该浏览器不支持webgl / Canvas, 请更换浏览器后尝试！"),new Error("该浏览器不支持webgl / Canvas, 请更换浏览器后尝试！");this.architewebgl=new ArchiteWebGL(t,e)}return t.prototype.render=function(){TWEEN.update(),this.architewebgl.render()},t.prototype.windowResize=function(t,e){V_WIDTH=t,V_HEIGHT=e,this.architewebgl.resize()},t}(),ArchiteWebGL=function(){function t(t,e){this.domContainer=null,this.controlDom=null,this.renderer=null,this.camera=null,this.scene=null,this.curArchite=null,this.defalutCameraPosition=new THREE.Vector3(0,0,0),this.curCameraPosition=new THREE.Vector3(0,0,0),this.defalutCameraTween=null,this.maxPolarAngleInit=Math.PI/2,this.perspectiveControlSet={minPolarAngle:0,maxPolarAngle:Math.PI/2},this.perspectiveControl=null,this.cameraControls=[],this.planeScene=null,this.is3D=!0,this.labelScene=null,this.labelCamera=null,this.lookatTween=null,this.lookatVector3=new THREE.Vector3(0,0,0),this.selectEnabled=!0,this.raycaster=null,this.meshSelDownPoint=new THREE.Vector2(0,0),this.isSel=!0,this.SelMesh=null,this.SelMaterial=new THREE.MeshLambertMaterial({color:16776960,emissing:0,transparent:!0,opacity:1}),this.SelEffectTweenAlpha1=null,this.SelEffectTweenAlpha0=null,this.SelPlane=null,this.SelMaterialPlane=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:1}),this.SelEffectTweenAlphaPlane1=null,this.SelEffectTweenAlphaPlane0=null,this.mousePoint=new THREE.Vector2(0,0),this.domContainer=t,this.controlDom=e,this.init()}return t.prototype.init=function(){this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.lookatTween=new TWEEN.Tween(this.lookatVector3),this.scene=new THREE.Scene,this.planeScene=new THREE.Scene,this.labelScene=new THREE.Scene,this.createPerspective(),this.defalutCameraTween=new TWEEN.Tween(this.curCameraPosition),this.perspectiveTween=new TWEEN.Tween(this.perspectiveControlSet),this.createOrthographic(),this.createLights(),this.createMeshSel(),this.renderer.setClearColor(15856375),this.renderer.setSize(V_WIDTH,V_HEIGHT),this.renderer.autoClear=!1,this.domContainer.appendChild(this.renderer.domElement)},t.prototype.lookatYTweento=function(t){var e=this;e.is3D&&(e.lookatVector3.copy(e.perspectiveControl.target),e.lookatTween.to({y:t},500).onUpdate(function(t){e.perspectiveControl.target.copy(this),e.perspectiveControl.update()}),e.lookatTween.start())},t.prototype.createOrthographic=function(){this.labelCamera=new THREE.OrthographicCamera(V_WIDTH/-2,V_WIDTH/2,V_HEIGHT/2,V_HEIGHT/-2,-FAER,2*FAER),this.labelCamera.position.z=10},t.prototype.createPerspective=function(){this.camera=new THREE.PerspectiveCamera(FOR,V_WIDTH/V_HEIGHT,NEAR,FAER),this.camera.up.set(0,1,0),this.camera.lookAt(new THREE.Vector3(0,0,0)),this.camera.position.z=1200;var t=new THREE.OrbitControls(this.camera,this.controlDom);t.maxPolarAngle=Math.PI/2,t.minPolarAngle=0,t.minDistance=20,t.minDistance=100,t.maxDistance=5e4,t.maxDistance=1/0,t.enableKeys=!1,this.perspectiveControl=t,this.cameraControls.push(t)},t.prototype.createLights=function(){var t=new THREE.AmbientLight(16777215,.65);this.scene.add(t);var e=new THREE.DirectionalLight(16777215,.4);e.color.setHSL(.1,1,.95),e.position.set(1,1.75,0),e.position.multiplyScalar(60),this.scene.add(e)},t.prototype.zoomIn=function(){for(var t=0;t<this.cameraControls.length;t++){var e=this.cameraControls[t];e.zoomIn()}},t.prototype.zoomAway=function(){for(var t=0;t<this.cameraControls.length;t++){var e=this.cameraControls[t];e.zoomOut()}},t.prototype.enabledRotateUp=function(t){for(var e=0;e<this.cameraControls.length;e++){var i=this.cameraControls[e];i.enableRotateUp=t}},t.prototype.enabledRotateLeft=function(t){for(var e=0;e<this.cameraControls.length;e++){var i=this.cameraControls[e];i.enableRotateLeft=t}},t.prototype.backgroundSet=function(t){t=t||15856375,this.renderer&&this.renderer.setClearColor(t)},t.prototype.enabledMapMove=function(t){for(var e=0;e<this.cameraControls.length;e++){var i=this.cameraControls[e];i.enablePan=t}},t.prototype.render=function(){this.curArchite&&this.curArchite.updateBillBoards(this.camera),this.renderer.clear(),this.is3D?(this.renderer.render(this.scene,this.camera),this.renderer.clearDepth(),this.renderer.render(this.labelScene,this.labelCamera)):(this.renderer.render(this.planeScene,this.camera),this.renderer.clearDepth(),this.renderer.render(this.labelScene,this.labelCamera))},t.prototype.reset=function(){this.perspectiveControl.target.copy(this.perspectiveControl.target0)},t.prototype.enabled3D=function(t){var e=this;e.SelMesh&&(e.SelMesh.material=e.SelMesh.defaultMaterial,e.SelMesh=null),e.SelPlane&&(e.SelPlane.material=e.SelPlane.defaultMaterial,e.SelPlane=null),t?(e.is3D=t,e.curCameraPosition.copy(e.camera.position),e.perspectiveControl.maxPolarAngle=e.maxPolarAngleInit,e.defalutCameraTween.stop(),e.defalutCameraTween.to({x:e.defalutCameraPosition.x,y:e.defalutCameraPosition.y,z:e.defalutCameraPosition.z},500).onUpdate(function(){e.camera.position.copy(this),e.perspectiveControl.update()}),e.defalutCameraTween.start()):(e.defalutCameraPosition.copy(this.camera.position),e.perspectiveTween.stop(),e.perspectiveControlSet.maxPolarAngle=Math.PI/2,e.perspectiveTween.to({maxPolarAngle:0},1e3).onUpdate(function(){e.perspectiveControl.maxPolarAngle=this.maxPolarAngle,e.perspectiveControl.update()}).onComplete(function(){e.is3D=t,e.curArchite&&e.curArchite.display2DPattern()}),e.perspectiveTween.start())},t.prototype.pubPointEnabled=function(t){this.curArchite&&this.curArchite.enabledFloorsPubPoints(t)},t.prototype.funcAreasLabelEnabled=function(t){this.curArchite&&this.curArchite.enabledFloorsLabel(t)},t.prototype.updateMapByArchiteBase=function(t){this.curArchite=t,t&&(IsPC()?this.defalutCameraPosition.set(0,1367,-1269):this.defalutCameraPosition.set(0,2348,-2529),this.camera.position.copy(this.defalutCameraPosition),this.perspectiveControl.update(),this.scene.add(t.floorGround),this.planeScene.add(t.floorGround2D),this.scene.add(t.ArchiteMesh),this.planeScene.add(t.ArchiteMesh2D),this.labelScene.add(t.ArchiteSprite),t.showFloorsMeshByID(t.getDefaultFoolr()),t.enabledFloorsPubPoints(!0),t.enabledFloorsLabel(!0))},t.prototype.resize=function(){this.renderer.setSize(V_WIDTH,V_HEIGHT),this.camera.aspect=V_WIDTH/V_HEIGHT,this.camera.updateProjectionMatrix(),this.labelCamera.left=V_WIDTH/-2,this.labelCamera.right=V_WIDTH/2,this.labelCamera.top=V_HEIGHT/2,this.labelCamera.bottom=V_HEIGHT/-2,this.labelCamera.updateProjectionMatrix()},t.prototype.createMeshSel=function(){var t=this;this.SelEffectTweenAlpha1=new TWEEN.Tween(this.SelMaterial),this.SelEffectTweenAlpha0=new TWEEN.Tween(this.SelMaterial),this.SelEffectTweenAlpha1.to({opacity:1},500),this.SelEffectTweenAlpha0.to({opacity:0},500).onComplete(function(){t.SelEffectTweenAlpha1.start()}),this.SelEffectTweenAlphaPlane1=new TWEEN.Tween(this.SelMaterialPlane),this.SelEffectTweenAlphaPlane0=new TWEEN.Tween(this.SelMaterialPlane),this.SelEffectTweenAlphaPlane1.to({opacity:1},500),this.SelEffectTweenAlphaPlane0.to({opacity:0},500).onComplete(function(){t.SelEffectTweenAlphaPlane1.start()}),this.raycaster=new THREE.Raycaster,this.controlDom.addEventListener("mousedown",function(e){t.meshSelDownPoint.x=e.clientX,t.meshSelDownPoint.y=e.clientY}),this.controlDom.addEventListener("mouseup",function(e){Math.abs(t.meshSelDownPoint.x-e.clientX)>3||Math.abs(t.meshSelDownPoint.y-e.clientY)>3?t.isSel=!1:t.isSel=!0}),this.controlDom.addEventListener("click",function(e){if(t.isSel&&t.curArchite&&t.selectEnabled){if(!t.curArchite.ArchiteMesh)return;t.mousePoint.x=e.clientX/V_WIDTH*2-1,t.mousePoint.y=2*-(e.clientY/V_HEIGHT)+1,t.raycaster.setFromCamera(t.mousePoint,t.camera);var i=[];i=t.is3D?t.raycaster.intersectObjects(t.curArchite.ArchiteMesh.children,!0):t.raycaster.intersectObjects(t.curArchite.ArchiteMesh2D.children,!0),i.length&&t.selMeshHandler(i[0])}})},t.prototype.searchFuncArea=function(t){if(this.curArchite){var e=this.curArchite.search(t);e?this.is3D?this.selMeshHandler({object:e.mesh.children[0]}):this.selMeshHandler({object:e.plane.children[0]}):msg("未找到："+t)}else msg("不存在建筑供查询！")},t.prototype.selMeshHandler=function(t){if(t&&t.object){var e=t.object;this.is3D?(this.SelMesh&&(this.SelMesh.material=this.SelMesh.defaultMaterial,this.SelMesh=null),this.SelMesh=e,e.material=this.SelMaterial,this.SelMaterial.opacity=1,this.SelEffectTweenAlpha0.start()):(this.SelPlane&&(this.SelPlane.material=this.SelPlane.defaultMaterial,this.SelPlane=null),this.SelPlane=e,e.material=this.SelMaterialPlane,this.SelMaterialPlane.opacity=1,this.SelEffectTweenAlphaPlane0.start())}},t}();Rect.prototype.isCollide=function(t){return!(t.br[0]<this.tl[0]||t.tl[0]>this.br[0]||t.br[1]<this.tl[1]||t.tl[1]>this.br[1])};var ArchiteUI=function(){function t(t,e){this.webgl=null,this.uiStyles=null,this.uiStylesStr="",this.domClass="",this.domID="",this.checkBoxContainer=null,this.domContainer=null,this.curArchite=null,this.scaleDomContainer=null,this.createSearch=!1,this.pubPoint=null,this.funcAreaName=null,this.funcAreaSelect=null,this.yAxisRotation=null,this.xAxisRotation=null,this.moveMap=null,this.viewModels=null,this.floorDom=null,this.backgroundColorChange=null,this.webgl=e,this.domContainer=t,this.domID=d3.select(t).attr("id"),this.domClass=d3.select(t).attr("class"),IsPC()?(this.appendUIStyle(".architeScaleContainer{position:absolute;top:1vw;left:1vw;width:2vw;height:4vw;}"),this.appendUIStyle(".scaleBtn{width:100%;height:50%;}"),this.appendUIStyle(".architeSearchDiv{position:absolute;right:1vw;top:1vw;}"),this.appendUIStyle(".architeFloorBtnContainer{position:absolute;right:1vw;top:6vw;width:2vw;}"),this.appendUIStyle(".architeFloorBtn{width:100%;height:2vw;}"),this.appendUIStyle(".architeFloorList{width:100%;}"),this.appendUIStyle(".architeSearchInput{width: 20vw;height:1.8vw;line-height: 1.8vw;}"),this.appendUIStyle(".architeSearchBtn{ width:3vw;height:2vw;}"),this.appendUIStyle(".checkBoxContainer{position:absolute;top:6vw;left:1vw;}"),this.appendUIStyle(".architeSwitchDiv{width:9vw;height:2vw;line-height: 2vw;display:table;}"),this.appendUIStyle(".architeSwitchCheckBox{width:2vw;display: table-cell;vertical-align: middle;}"),this.appendUIStyle(".architeBackgroundColorChange {width: 7vw;height: 2vw;padding-right: 2vw;}"),this.appendUIStyle(".webgl_backgroundColor{float:right;width:1vw;background:#f1f2f7;height:1vw;margin-right: 1.8vw;border:1px solid #000;")):(this.appendUIStyle(".architeScaleContainer{position:absolute;top:1vw;left:1vw;width:8vw;height:12vw;}"),this.appendUIStyle(".scaleBtn{width:100%;height:50%;}"),this.appendUIStyle(".architeSearchDiv{position:absolute;right:1vw;top:1vw;}"),this.appendUIStyle(".architeFloorBtnContainer{position:absolute;right:1vw;top:16vw;width:8vw;}"),this.appendUIStyle(".architeFloorBtn{width:100%;height:6vw;}"),this.appendUIStyle(".architeFloorList{width:100%;}"),this.appendUIStyle(".architeSearchInput{width: 24vw;height:4.6vw;line-height: 4.6vw;}"),this.appendUIStyle(".architeSearchBtn{ width:12vw;height:6vw;}"),this.appendUIStyle(".checkBoxContainer{position:absolute;top:18vw;left:1vw;}"),this.appendUIStyle(".architeSwitchDiv{width:25vw;height:7vw;line-height: 7vw;display:table;}"),this.appendUIStyle(".architeSwitchCheckBox{width:4vw;display: table-cell;vertical-align: middle;}"),this.appendUIStyle(".architeBackgroundColorChange {width: 25vw;height: 7vw;}"),this.appendUIStyle(".webgl_backgroundColor{float:right;width:4vw;background:#f1f2f7;height:4vw;margin-right: 1.8vw;margin-top:1vw;border:1px solid #000;")),this.checkBoxContainer=d3.select(t).append("div").attr("class","checkBoxContainer")}return t.prototype.appendUIStyle=function(t){this.uiStyles||(this.uiStyles=d3.select("head").append("style")),this.domID?t+=this.domID+" "+t:this.domClass&&(t+=this.domClass+" "+t),this.uiStylesStr+=t,this.uiStyles.html(this.uiStylesStr)},t.prototype.openScale=function(){if(this.scaleDomContainer)return void console.log("放大缩小按钮已创建！！！");var t=d3.select(this.domContainer).append("div").attr("class","architeScaleContainer");this.scaleDomContainer=t;var e=this;this.createBtn(t,"+","scaleBtn",function(){e.webgl&&e.webgl.zoomIn()}),this.createBtn(t,"-","scaleBtn",function(){e.webgl&&e.webgl.zoomAway()})},t.prototype.createBtn=function(t,e,i,a){a=a||function(){},i=""==i?null:i,i=i||"architeBtn";var o=t.append("button");return o.attr("class",i),o.text(e),o.on("click",function(t){a()}),o},t.prototype.updataUIByArchiteBase=function(t){this.curArchite=t,this.createFloorsBtn(t)},t.prototype.openSearch=function(){if(this.createSearch)return void console.log("搜索已经创建功能已经创建");this.createSearch=!0;var t=this,e=d3.select(this.domContainer).append("div").attr("class","architeSearchDiv"),i=e.append("input").attr("class","architeSearchInput");t.createBtn(e,"搜索","architeSearchBtn",function(){var e=i[0][0].value;return e?""==e?void msg("搜索内容为空！！"):void(t.webgl&&t.webgl.searchFuncArea(e)):void msg("搜索内容为空！！")})},t.prototype.createCheckBox=function(t,e,i){i=i||function(){};var a=this.checkBoxContainer.append("div").attr("class","architeSwitchDiv"),o=(a.append("span").attr("class","architeSwitchName").text(t),a.append("input").attr({class:"architeSwitchCheckBox",type:"checkbox",checked:"",name:"open",title:t}));return a.on("click",function(t){var e=o[0][0].checked;i(e)}),a},t.prototype.showPubPointSwitch=function(){var t=this;this.pubPoint||(this.pubPoint=this.createCheckBox("公共设施",[0,100,0,0],function(e){console.log("公共设施:"+e),t.webgl&&t.webgl.pubPointEnabled(e)}))},t.prototype.showFuncAreaNameSwitch=function(){var t=this;this.funcAreaName||(this.funcAreaName=this.createCheckBox("店铺名称",[0,100,0,0],function(e){console.log("店铺名称:"+e),t.webgl&&t.webgl.funcAreasLabelEnabled(e)}))},t.prototype.showFuncSelectSwitch=function(){var t=this;this.funcAreaSelect||(this.funcAreaSelect=this.createCheckBox("店铺选择",[0,100,0,0],function(e){console.log("店铺选择:"+e),t.webgl&&(t.webgl.selectEnabled=e)}))},t.prototype.showYAxisRotateSwitch=function(){var t=this;this.yAxisRotation||(this.yAxisRotation=this.createCheckBox("左右旋转",[0,100,0,0],function(e){console.log("左右旋转:"+e),t.webgl&&t.webgl.enabledRotateLeft(e)}))},t.prototype.showXAxisRotateSwitch=function(){var t=this;this.xAxisRotation||(this.xAxisRotation=this.createCheckBox("上下旋转",[0,100,0,0],function(e){console.log("上下旋转:"+e),t.webgl&&t.webgl.enabledRotateUp(e)}))},t.prototype.showMoveMapSwitch=function(){var t=this;this.moveMap||(this.moveMap=this.createCheckBox("移动地图",[0,100,0,0],function(e){console.log("移动地图:"+e),t.webgl&&t.webgl.enabledMapMove(e)}))},t.prototype.viewPatternSwitch=function(){var t=this;this.viewModels||(this.viewModels=this.createCheckBox("三维展示",[0,100,0,0],function(e){console.log("三维展示:"+e),t.webgl&&t.webgl.enabled3D(e)}))},t.prototype.createFloorsBtn=function(t){var e=this;if(!e.floorDom){var i=t.oriData.Floors||[];e.floorDom=d3.select(e.domContainer).append("div"),e.floorDom.attr("class","architeFloorBtnContainer");var a=e.floorDom,o=a.append("button").attr("class","architeFloorBtn").text("All");o.on("click",function(t){e.showAllFloors()});var r=a.append("div").attr("class","architeFloorList");r.selectAll("button").remove();r.selectAll("button").data(i).enter().append("button").attr("class","architeFloorBtn").text(function(t){return t.Name||"--"}).on("click",function(t){e.selectFloor(t)})}},t.prototype.selectFloor=function(t){console.log(t);var e=!0,i=this.curArchite.showFloorsMeshByID(t._id,e);this.webgl&&this.webgl.lookatYTweento(i.yAxis)},t.prototype.showAllFloors=function(){this.webgl&&(this.webgl.reset(),this.webgl.enabled3D(!0)),this.curArchite&&this.curArchite.showAllFloors()},t.prototype.createBackgroundSet=function(){var t=this;if(!this.backgroundColorChange){var e=this.checkBoxContainer.append("div").attr("class","architeBackgroundColorChange");this.backgroundColorChange=e;var i=(e.append("label").attr("class","architeBackgroundName").text("背景颜色"),e.append("div").attr("class","webgl_backgroundColor"));$(".webgl_backgroundColor").colpick({color:"f1f2f7",onSubmit:function(e,a,o,r){i.style("background","#"+a),a="0x"+a,a=Math.floor(a),t.webglBackgroundChange(a)}})}},t.prototype.webglBackgroundChange=function(t){this.webgl&&this.webgl.backgroundSet(t)},t}();